{
  "info": {
    "_postman_id": "83368588-9985-40f6-9df5-fde66e9a84d4",
    "name": "GameServer - End-to-end test",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "OAuth2",
      "item": [
        {
          "name": "OAuth2-Auth",
          "event": [
            {
              "listen": "test",
              "script": {
                "id": "d5d79272-48e7-49bf-af01-8b481e69f0ba",
                "exec": [
                  "pm.test(\"response is ok\",  ()=>{\r",
                  "if( pm.response.to.have.status(200))\r",
                  "{\r",
                  "    var txt = pm.response.text();\r",
                  "    var jsonData = JSON.parse(txt);\r",
                  "    var envState = pm.collectionVariables.get(\"vars.state\");\r",
                  "    if ( jsonData.code != \"\" && jsonData.state == envState )\r",
                  "    {\r",
                  "        console.log(\"Setting code:\" + jsonData.code);\r",
                  "        pm.collectionVariables.set(\"vars.code\", jsonData.code);\r",
                  "        return;\r",
                  "    }\r",
                  "\r",
                  "    // Fail    \r",
                  "    pm.expect.fail();\r",
                  "}})"
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "id": "7c5d8367-79b4-4867-a56b-9cbbbe7f6816",
                "exec": [
                  "function generateRandomStringShort() {",
                  "  return Math.random().toString(36).slice(2);",
                  "}",
                  "",
                  "var state = generateRandomStringShort();",
                  "pm.collectionVariables.set(\"vars.state\", state);",
                  ""
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            }
          ],
          "id": "cf5c0282-758c-43b0-9300-4373b2afed0d",
          "request": {
            "method": "PUT",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\r\n  \"clientId\": \"{{ClientId}}\",\r\n  \"clientSecret\": \"{{ClientSecret}}\",\r\n  \"redirectUri\": \"{{redirectUri}}\",\r\n  \"scope\": \"{{ClientScope}}\",\r\n  \"state\": \"{{vars.state}}\"\r\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{server_address}}/Account/auth",
              "host": [
                "{{server_address}}"
              ],
              "path": [
                "Account",
                "auth"
              ]
            }
          },
          "response": []
        },
        {
          "name": "OAuth2-Code",
          "event": [
            {
              "listen": "test",
              "script": {
                "id": "1831b76f-d485-4771-90f3-5cb5772e2fd5",
                "exec": [
                  "pm.test(\"response is ok\",  ()=>{\r",
                  "if( pm.response.to.have.status(200))\r",
                  "{\r",
                  "    var txt = pm.response.text();\r",
                  "    var jsonData = JSON.parse(txt);\r",
                  "    if (jsonData.errorCode == 0)\r",
                  "    {\r",
                  "        console.log(\"Setting access_token:\" + jsonData.accessToken);\r",
                  "        pm.collectionVariables.set(\"vars.access_token\", jsonData.accessToken);\r",
                  "        return;\r",
                  "    }\r",
                  "\r",
                  "    // Fail the test since login fails\r",
                  "    pm.expect.fail();\r",
                  "}})"
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "id": "ad7b283d-3c74-4004-b65b-72a608d5f0fc",
                "exec": [
                  ""
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            }
          ],
          "id": "2781c2b1-3fbf-4f83-9aa9-e0f7d1fd476c",
          "request": {
            "method": "PUT",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\r\n  \"code\": \"{{vars.code}}\",\r\n  \"state\": \"{{vars.state}}\"\r\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{server_address}}/Account/code",
              "host": [
                "{{server_address}}"
              ],
              "path": [
                "Account",
                "code"
              ]
            }
          },
          "response": []
        }
      ],
      "id": "145d167a-69ba-4da4-874a-32abb27c4557"
    },
    {
      "name": "Account",
      "item": [
        {
          "name": "CreateAccount",
          "id": "34735d5e-fa44-44d1-a810-8e824b49bcb9",
          "request": {
            "method": "PUT",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\r\n  \"username\": \"{{vars.login_username}}\",\r\n  \"password\": \"{{vars.login_password}}\",\r\n  \"nickname\": \"{{vars.login_nickname}}\",\r\n  \"email\": \"{{vars.login_username}}@email.com\"\r\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{server_address}}/Account/CreateAccount",
              "host": [
                "{{server_address}}"
              ],
              "path": [
                "Account",
                "CreateAccount"
              ]
            }
          },
          "response": []
        },
        {
          "name": "LoginUser",
          "id": "e0bbc79a-95d9-423c-b0ca-f8c8a2e46e7a",
          "request": {
            "method": "PUT",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\r\n  \"username\": \"{{vars.login_username}}\",\r\n  \"password\": \"{{vars.login_password}}\"\r\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{server_address}}/Account/LoginAccount",
              "host": [
                "{{server_address}}"
              ],
              "path": [
                "Account",
                "LoginAccount"
              ]
            }
          },
          "response": []
        }
      ],
      "id": "4717934d-3528-4819-adde-65f868072787",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "id": "7d2664b5-f208-4720-b57a-0de144e6f797",
            "type": "text/javascript",
            "packages": {},
            "requests": {},
            "exec": [
              "// ",
              "// Common functions",
              "//",
              "",
              "function generateRandomStringShort() ",
              "{",
              "  return Math.random().toString(36).slice(2);",
              "}",
              "",
              "function generateOrSetVariable(variableName, variableValue )",
              "{",
              "    var col = pm.collectionVariables;",
              "    var currentValue = col.get(\"vars.\" + variableName);",
              "    if ( !currentValue )",
              "    {",
              "        variableValue = variableValue + generateRandomStringShort();",
              "        col.set(\"vars.\" + variableName, variableValue);",
              "    }",
              "}",
              "",
              "function setVariableIfEmpty(variableName, variableValue)",
              "{",
              "    var col = pm.collectionVariables;",
              "    var currentValue = col.get(\"vars.\" + variableName);",
              "    if ( !currentValue )",
              "    {",
              "        col.set(\"vars.\" + variableName, variableValue);",
              "    }",
              "}",
              "",
              "function unicodeToBase64(str) {",
              "  // Encode string to UTF-8 bytes",
              "  const utf8Bytes = new TextEncoder().encode(str);",
              "  // Convert the byte array to a binary string that btoa can accept",
              "  const binaryString = String.fromCharCode(...utf8Bytes);",
              "  // Encode the binary string to Base64",
              "  return btoa(binaryString);",
              "}",
              "",
              "const unicodeString = \"ä½ å¥½, world! ðŸ‘‹\";",
              "const encoded = unicodeToBase64(unicodeString);",
              "console.log(encoded);",
              "// Output: \"5L2g5aW9LCB3b3JsZCEg8J+YgQ==\"",
              "",
              "//",
              "// Generate unique username/nickname",
              "//",
              "generateOrSetVariable(\"login_username\",\"User\");",
              "generateOrSetVariable(\"login_nickname\", \"Nick\");",
              "",
              "cleartextPassword = generateRandomStringShort();",
              "encodedPassword = unicodeToBase64(cleartextPassword);",
              "setVariableIfEmpty(\"login_password\", encodedPassword);",
              ""
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "id": "cdff1f0b-e4f6-4370-a558-009b2b3412a1",
            "type": "text/javascript",
            "packages": {},
            "requests": {},
            "exec": [
              "pm.test(\"response is ok\",  ()=>{",
              "if( pm.response.to.have.status(200))",
              "{",
              "    var txt = pm.response.text();",
              "    var jsonData = JSON.parse(txt);",
              "    if (jsonData.errorCode == 0)",
              "    {",
              "        console.log(\"Setting token:\" + jsonData.token);",
              "        pm.collectionVariables.set(\"vars.login_token\", jsonData.token);",
              "        return;",
              "    }",
              "    ",
              "    // Fail the test since login fails",
              "    pm.expect.fail();",
              "}})"
            ]
          }
        }
      ]
    },
    {
      "name": "Playfield",
      "item": [
        {
          "name": "GetPlayfieldList",
          "id": "71311cc5-863d-470a-b977-0ff47ed27646",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": ""
            }
          },
          "response": []
        },
        {
          "name": "SavePlayfield",
          "id": "b9d5ace1-08a5-418c-be17-367af7ce9dec",
          "request": {
            "method": "PUT",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"uuid\":\"1234\",\n    \"revisionId\":\"1\",\n    \"owner\":\"{{vars.login_nickname}}\",\n    \"name\" : \"name-of-playfield\",\n    \"description\" : \"description\",\n    \"playfieldFlags\" : \"0\",\n    \"numPlayers\" : \"2\",\n    \"numGoals\" : \"1\",\n    \"boardSizeX\" : \"4\",\n    \"boardSizeY\" : \"4\",\n    \"version\" : \"1\",\n    \"data\" : \"data\"\n}\n",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{server_address}}/Playfield/SavePlayfield",
              "host": [
                "{{server_address}}"
              ],
              "path": [
                "Playfield",
                "SavePlayfield"
              ]
            }
          },
          "response": []
        }
      ],
      "id": "7b0c5763-51aa-4241-ab49-aa87bc453259"
    },
    {
      "name": "Cleanup",
      "item": [
        {
          "name": "DeleteAccount",
          "id": "5179e888-e3b7-4924-893a-6a2e7655338e",
          "request": {
            "method": "PUT",
            "header": [],
            "url": {
              "raw": "{{server_address}}/Account/DeleteAccount",
              "host": [
                "{{server_address}}"
              ],
              "path": [
                "Account",
                "DeleteAccount"
              ]
            }
          },
          "response": []
        }
      ],
      "id": "0c890077-1b77-4aff-aef7-99036b949cb1"
    }
  ],
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{vars.access_token}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "id": "f14d6c27-2e0a-44b6-85c0-3a5eeb72a981",
      "key": "vars.access_token",
      "value": ""
    },
    {
      "id": "f56c130e-76fc-4ac9-84a2-0b6d8a2d9a5f",
      "key": "vars.state",
      "value": ""
    },
    {
      "id": "8f8d1843-1bdd-4d97-ad6c-938799091dd7",
      "key": "vars.code",
      "value": ""
    },
    {
      "id": "11d60db4-29c4-45b4-8385-55cb42f62cfd",
      "key": "vars.login_username",
      "value": ""
    },
    {
      "id": "b75c53e4-2972-4f13-b772-5c0bdb243cd4",
      "key": "vars.login_nickname",
      "value": ""
    },
    {
      "id": "56b510ba-1eab-4201-bf72-ec71333a84f4",
      "key": "vars.login_password",
      "value": ""
    },
    {
      "id": "61257330-1506-44fb-966d-a50355ab4470",
      "key": "vars.login_token",
      "value": ""
    }
  ]
}